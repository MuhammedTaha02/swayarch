#!/bin/bash

#
# spawn
#
# Desc: switches focus to an application if it is running
# if not it starts the application
#
# Requirements
# Swaymsg
# jq
# kitty terminal emulator (can easily be changed to work
#       another terminal as long as it can assign the title
#
# Arguments:
# 1: name of application or session
# 2: type if the application is a dropdown, session or terminal app
#


[ -z "$1" ] && exit

APP_NAME=$1

# Compares the requested app to running apps list if it finds it it returns
# only the name of the keys where it is found (i.e. app_id, class, or title)
RUNNING_APP_TYPES=$(swaymsg -t get_tree | jq -r --arg TEST_APP $APP_NAME 'recurse(.nodes[]?) 
	| recurse(.floating_nodes[]?) 
	| select(.type=="floating_con" or .type=="con") 
	| {app_id: .app_id, class: .window_properties.class, title: .name} 
	| with_entries(select(.value!=null)) 
	| with_entries(select(.value|test($TEST_APP))) | keys')

# Gets just the first key name in the list.  The list is sorted by the best 
# match (app_id, class, title) so that the right window is chosen
BEST_APP_TYPE=$(echo $RUNNING_APP_TYPES | awk -F'"' '$0=$2' | awk 'NR==1{print $1}')

# Converts the second argument to lowercase
APP_TYPE=$( echo "$2" | awk '{print tolower($0)}')

case $APP_TYPE in
	"session") 
		# Kitty session - session files are stored in $HOME/.config/kitty and
		# should have the name of window title you want (i.e. wintitle_session)
		if [[ $RUNNING_APP_TYPES =~ "title" ]]
		then
			swaymsg "[title=\"$APP_NAME\"] focus"
		else
			swaymsg exec "kitty --title=\"$APP_NAME\" --session=\"$HOME/.config/kitty/$APP_NAME"_session\"""
		fi
		;;
	"dropdown") 
		# Dropdown terminal apps that are hidden in the scratchpad
		# and this script will bring each forward when called
		# Only terminal apps are supported at this time
		if [[ ! $RUNNING_APP_TYPES =~ "title" ]]
		then
			swaymsg exec "kitty --title=\"Dropdown $APP_NAME\" $APP_NAME"
			sleep 1
			swaymsg '[title=\"$Dropdown $APP_NAME\"] move scratchpad'
		fi
		swaymsg "[title=\"Dropdown $APP_NAME\"] scratchpad show; \
			[title=\"Dropdown $APP_NAME\"] move position center; \
			[title=\"Dropdown $APP_NAME\"] resize set 600 500"
		;;
	"terminal")
		# Terminal apps are run with kitty with the title: "appname - kitty"
		if [[ $RUNNING_APP_TYPE =~ "title" ]]
		then
			swaymsg "[title=\"$APP_NAME\"] focus"
		else
			swaymsg exec "kitty --title=\"$APP_NAME - Kitty\" $APP_NAME"
		fi
		;;
	*)
		# All other applications
		if [ -z $BEST_APP_TYPE ] 
		then
			swaymsg exec $APP_NAME
		else
			swaymsg "[$BEST_APP_TYPE=\"$APP_NAME\"] focus"
		fi
		;;
esac

